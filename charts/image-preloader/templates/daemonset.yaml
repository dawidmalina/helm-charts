{{- if gt (len .Values.images) 0 }}
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: {{ include "image-preloader.fullname" . }}
  labels:
    {{- include "image-preloader.labels" . | nindent 4 }}
spec:
  updateStrategy:
    {{- toYaml .Values.updateStrategy | nindent 4 }}
  selector:
    matchLabels:
      {{- include "image-preloader.selectorLabels" . | nindent 6 }}
  template:
    metadata:
      annotations:
        checksum/config: {{ .Values.images | toJson | sha256sum }}
        {{- with .Values.podAnnotations }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
      labels:
        {{- include "image-preloader.selectorLabels" . | nindent 8 }}
        {{- with .Values.podLabels }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
    spec:
      {{- if .Values.serviceAccount.create }}
      serviceAccountName: {{ include "image-preloader.serviceAccountName" . }}
      {{- end }}
      {{- with .Values.podSecurityContext }}
      securityContext:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      initContainers:
      - name: dind
        image: {{ .Values.image.repository }}:{{ .Values.image.tag }}
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        {{- with .Values.securityContext }}
        securityContext:
          {{- toYaml . | nindent 10 }}
        {{- end }}
        restartPolicy: Always
        args:
          - dockerd
          - --host=unix:///var/run/docker.sock
          - --group=$(DOCKER_GROUP_GID)
          - --mtu={{ .Values.dockerd.mtu | default 1450 }}
          - --max-concurrent-downloads=4
          - --max-concurrent-uploads=2
          - --userland-proxy=false
          - --exec-opt=native.cgroupdriver=cgroupfs
        env:
        - name: DOCKER_GROUP_GID
          value: "{{ .Values.dockerd.groupGid | default 123 }}"
        - name: DOCKER_TLS_CERTDIR
          value: ""
        volumeMounts:
        - name: dind-sock
          mountPath: /var/run
        - name: docker-graph-storage
          mountPath: /var/lib/docker
        startupProbe:
          exec:
            command:
              - docker
              - info
          failureThreshold: 24
          periodSeconds: 5
          successThreshold: 1
          timeoutSeconds: 10
        {{- with .Values.dockerd.resources }}
        resources:
          {{- toYaml . | nindent 10 }}
        {{- end }}
      # The preload-images container runs the image preloading logic
      # The dind sidecar init container (with restartPolicy: Always) provides Docker daemon
      containers:
      - name: preload-images
        image: {{ .Values.image.repository }}:{{ .Values.image.tag }}
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        command: ["/bin/sh"]
        args:
          - -c
          - |
            set -e
            echo "Waiting for Docker daemon to be ready..."
            
            # Wait for Docker daemon to be ready (max 2 minutes)
            MAX_WAIT=120
            WAITED=0
            while ! docker info >/dev/null 2>&1; do
              if [ $WAITED -ge $MAX_WAIT ]; then
                echo "Error: Docker daemon did not become ready within ${MAX_WAIT} seconds"
                exit 1
              fi
              echo "Waiting for Docker daemon... ($WAITED/$MAX_WAIT seconds)"
              sleep 2
              WAITED=$((WAITED + 2))
            done
            
            echo "Docker daemon is ready"
            
            # Create target directory structure if it doesn't exist
            mkdir -p {{ .Values.hostPath }}
            
            echo "Starting Docker image preloading..."
            {{- range $image := .Values.images }}
            {{- $filename := include "image-preloader.imageToFilename" $image }}
            echo "Processing image: {{ $image }}"
            
            # Check if tar file already exists and its age
            SHOULD_REBUILD=false
            TAR_FILE="{{ $.Values.hostPath }}/{{ $filename }}"
            
            if [ -f "$TAR_FILE" ]; then
              {{- if ge (int $.Values.maxImageAge) 0 }}
              # Check file age
              FILE_MTIME=$(stat -c %Y "$TAR_FILE" 2>/dev/null || stat -f %m "$TAR_FILE" 2>/dev/null || echo "")
              
              if [ -z "$FILE_MTIME" ]; then
                echo "Warning: Unable to get modification time for {{ $filename }}, rebuilding..."
                SHOULD_REBUILD=true
              else
                FILE_AGE_SECONDS=$(expr $(date +%s) - $FILE_MTIME)
                MAX_AGE_SECONDS=$(expr {{ int $.Values.maxImageAge }} \* 86400)
                
                if [ $FILE_AGE_SECONDS -ge $MAX_AGE_SECONDS ]; then
                  echo "Image tar file {{ $filename }} is older than {{ $.Values.maxImageAge }} days (age: $(expr $FILE_AGE_SECONDS / 86400) days), rebuilding..."
                  SHOULD_REBUILD=true
                else
                  echo "Image {{ $image }} already exists as {{ $filename }} and is up-to-date (age: $(expr $FILE_AGE_SECONDS / 86400) days), skipping..."
                fi
              fi
              {{- else }}
              echo "Image {{ $image }} already exists as {{ $filename }}, skipping (age check disabled)..."
              {{- end }}
            else
              echo "Image tar file {{ $filename }} does not exist, building..."
              SHOULD_REBUILD=true
            fi
            
            if [ "$SHOULD_REBUILD" = "true" ]; then
              # Pull the image
              if docker pull {{ $image }}; then
                echo "Successfully pulled {{ $image }}"
                
                # Create subdirectory if needed (for images like selenium/standalone-firefox)
                TARGET_DIR=$(dirname "$TAR_FILE")
                mkdir -p "$TARGET_DIR"
                
                # Save the image to tar file
                if docker save {{ $image }} -o "$TAR_FILE"; then
                  echo "Successfully saved {{ $image }} to {{ $filename }}"
                else
                  echo "Error: Failed to save {{ $image }}"
                  exit 1
                fi
              else
                echo "Error: Failed to pull {{ $image }}"
                exit 1
              fi
            fi
            {{- end }}
            
            echo "Docker image preloading completed successfully"
            
            # Keep the container running and check periodically for image updates
            echo "Preloading complete. Starting periodic check loop (interval: {{ .Values.checkInterval }} seconds)..."
            while true; do
              echo "Sleeping for {{ .Values.checkInterval }} seconds before next check..."
              sleep {{ .Values.checkInterval }}
              
              echo "Starting periodic image age check..."
              {{- range $image := .Values.images }}
              {{- $filename := include "image-preloader.imageToFilename" $image }}
              echo "Checking image: {{ $image }}"
              
              # Check if tar file already exists and its age
              SHOULD_REBUILD=false
              TAR_FILE="{{ $.Values.hostPath }}/{{ $filename }}"
              
              if [ -f "$TAR_FILE" ]; then
                {{- if ge (int $.Values.maxImageAge) 0 }}
                # Check file age
                FILE_MTIME=$(stat -c %Y "$TAR_FILE" 2>/dev/null || stat -f %m "$TAR_FILE" 2>/dev/null || echo "")
                
                if [ -z "$FILE_MTIME" ]; then
                  echo "Warning: Unable to get modification time for {{ $filename }}, rebuilding..."
                  SHOULD_REBUILD=true
                else
                  FILE_AGE_SECONDS=$(expr $(date +%s) - $FILE_MTIME)
                  MAX_AGE_SECONDS=$(expr {{ int $.Values.maxImageAge }} \* 86400)
                  
                  if [ $FILE_AGE_SECONDS -ge $MAX_AGE_SECONDS ]; then
                    echo "Image tar file {{ $filename }} is older than {{ $.Values.maxImageAge }} days (age: $(expr $FILE_AGE_SECONDS / 86400) days), rebuilding..."
                    SHOULD_REBUILD=true
                  else
                    echo "Image {{ $image }} is up-to-date as {{ $filename }} (age: $(expr $FILE_AGE_SECONDS / 86400) days), no rebuild needed."
                  fi
                fi
                {{- else }}
                echo "Image {{ $image }} exists as {{ $filename }}, skipping (age check disabled)..."
                {{- end }}
              else
                echo "Image tar file {{ $filename }} does not exist, building..."
                SHOULD_REBUILD=true
              fi
              
              if [ "$SHOULD_REBUILD" = "true" ]; then
                # Pull the image
                if docker pull {{ $image }}; then
                  echo "Successfully pulled {{ $image }}"
                  
                  # Create subdirectory if needed (for images like selenium/standalone-firefox)
                  TARGET_DIR=$(dirname "$TAR_FILE")
                  mkdir -p "$TARGET_DIR"
                  
                  # Save the image to tar file
                  if docker save {{ $image }} -o "$TAR_FILE"; then
                    echo "Successfully saved {{ $image }} to {{ $filename }}"
                  else
                    echo "Error: Failed to save {{ $image }}"
                    # Continue with other images instead of exiting
                  fi
                else
                  echo "Error: Failed to pull {{ $image }}"
                  # Continue with other images instead of exiting
                fi
              fi
              {{- end }}
              
              echo "Periodic image age check completed"
            done
        env:
        - name: DOCKER_HOST
          value: unix:///var/run/docker.sock
        volumeMounts:
        - name: images
          mountPath: {{ .Values.hostPath }}
        - name: dind-sock
          mountPath: /var/run
        {{- with .Values.resources }}
        resources:
          {{- toYaml . | nindent 10 }}
        {{- end }}
      volumes:
      - name: images
        hostPath:
          path: {{ .Values.hostPath }}
          type: DirectoryOrCreate
      - name: dind-sock
        emptyDir: {}
      - name: docker-graph-storage
        emptyDir: {}
{{- end }}
